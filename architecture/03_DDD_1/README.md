# 課題34: DDDを学ぶ（基礎）
## 課題1: DDD用語の説明

### エンティティ

ドメインモデルをモノとして表現するオブジェクトのひとつ。

例えば社員のモデルを考えた時に、以下のようなオブジェクトが考えられる。

```javascript
class Employee {
  constructor(id, name, age) {
    this.id = id;
    this.name = name;
    this.age = age;
  }
}
```

エンティティは、識別によって特定される。
例えば、社員は社員番号(id)という識別子で同一判定される。
社員は部署が変わっても、名前や年齢が変が変わっても同じ社員である。

### 値オブジェクト（バリューオブジェクト）

ドメインモデルをモノとして表現するオブジェクトのひとつ。

例えばお金のモデルを考えた時に、以下のようなオブジェクトが考えられる。

```javascript
class Money {
  constructor(value, material) {
    this.value = value;
    this.material = material;
  }
}
```

値オブジェクトは、属性値によって特定される。

例えば、上記のMoneyは価値(value)と材質(material)の値で同一判定される。
(10円玉硬貨ならvalue=10, material='coin'のようなイメージ)

オブジェクトの表現にエンティティを使うか、値オブジェクトを使うかは文脈によって変化する。

例えば硬貨や紙幣のコレクション管理するサービスがあり、お金に識別子をつけて一意に管理する必要があれば、Moneyはエンティティを用いる必要がある。

### 集約

集約とは、「必ず守りたい強い整合性を持ったオブジェクトのまとまり」を表す。

集約のルールは以下の2つがある。

- 強い整合性確保が必要なものを、1つの集約にする
- トランザクションを必ず1つにする

集約を取得・更新をする場合は、集約ごとに取得し更新を行う。これにより、強い整合性が必要なオブジェクトの不整合を防ぐことができる。

### ユビキタス言語

ドメインを定義するために使用する「共通言語」であり、開発者やビジネスサイドに関わらず同じ言葉を用いるための指針。

ユビキタスの意味は「In Everywhere」という意味で、「会話でも、ドキュメントでも、コードでも」ということを意味する。

どこでも同じ言葉を使うことで、言葉の変換による損失を極力なくすことを目指している。


### 境界づけられたコンテキスト

特定のモデルを定義・適用する境界を明示的に示したもの。代表的な境界の例は、 サブシステムやチームなど。

規模が大きくなるほど、1つのモデルで定義することが難しくなる。

そのため、同じ「商品」というモデルでも、販売のコンテキストと配送のコンテキストでモデルを分割し、コンテキスト内でのモデルと用語の統一を行う。

### ドメイン

「ソフトウェアで問題解決しようとする対象領域」を「ドメイン」と呼ぶ。

ドメインをコードとして表現するために、オブジェクトを使用する。

エンティティや値オブジェクトは、モノとしてモデリングされたドメインオブジェクトである。

### ドメインサービス

ドメインモデルをモノとして表現できない場合に定義する層。

オブジェクトの振る舞いや性質を表現する際に用いられる。
たとえば、ユーザーのメールアドレスの重複判定は、単一のオブジェクトでは表現できないためドメインサービスに記述することが望ましい。

### リポジトリ

集約単位で永続化層へのアクセスを提供するもの。DBとのアクセスする部分の実装のイメージ。

オブジェクトの整合性を確実に保証するため、集約単位でデータを扱うように実装するのが望ましい。

### アプリケーション（ユースケース層と呼ばれることも）

ドメイン層のクラスが公開しているメソッドを組み合わせて、ユースケースを実現する層。

ドメインオブジェクトの生成や状態の変更、リポジトリを使用した永続化などを行う。

### CQRS

CQRS(Command Query Responsibility Segregation: コマンドクエリ責務分離)

DDDを行うと、モデルやリポジトリの実装時に発生する問題を解決する方法。

アプリケーション(ユースケース層)でデータの参照・更新を1つのモデル/リポジトリで行うと、ユースケースの増大につれて肥大化・複雑化することがある。

これを避けるため、参照/更新のためにそれぞれモデルやリポジトリを分けたり、特定のユースケースに特化したモデルやリポジトリを作成することで見通しを良くする。

### DTO

DTO(Data Transfer Object: データ伝達オブジェクト)

コードに都合が良いオブジェクトを生成すると、コードが肥大化・複雑化するため、

アプリケーション(ユースケース)からの戻り値は、ドメインオブジェクトがあることが望ましい。

一方で、CQRSが必要な問題が発生した際は、参照に都合が良いオブジェクトとして伝達用のオブジェクト(DTO)を生成することで解決することができる。

基本的にはドメインオブジェクトを用いる方針を守り、解決すべき特殊なケースな場合はDTOを用いる。

## 課題2: クイズ

以下のクイズは書籍「ドメイン駆動開発設計 モデリング/実装ガイド (松岡幸一郎)」を参考にしています。

1. DDDを導入するにあたって、どのように取り組み始めるのが良いでしょうか？
2. Twitterのような外部APIを利用する時は、どの層に実装するのがよいでしょうか？
3. DDDを行うのに向いているプロジェクトはどのようなプロジェクトでしょうか？

<details>
  <summary>回答例</summary>

1. 解決したい課題を明確にし、課題ドリブンで行う。小さく初めて小さく失敗することで改善していく。
2. 外部APIで扱う値が、ドメインモデルとして意味を持つ場合はドメイン層のものとして定義し、リポジトリで設計する。
そうではない例として、ユースケースとして通知を行うためのAPIの場合はユースケース層にインターフェースを定義し、実装クラスはインフラ層に配置する。
3. 問題解決しようとするドメインが複雑な場合。複雑なドメインを、モデリングを中心としたアプローチによって問題解決する際に高い効力がある。一方でシンプルな構成で解決できる課題の場合は、DDDの導入がオーバーヘッドになってしまうため不向き。


</details>
