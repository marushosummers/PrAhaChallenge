# 課題32: オニオンアーキテクチャを学ぶ

## 課題１

###  オニオンアーキテクチャ

![オニオンアーキテクチャ](https://cdn-ak.f.st-hatena.com/images/fotolife/l/little_hands/20171011/20171011062558.png)

考: [[DDD]ドメイン駆動 + オニオンアーキテクチャ概略](https://little-hands.hatenablog.com/entry/2017/10/11/075634)

オニオンアーキテクチャはDDD(ドメイン駆動開発)での設計パターンのひとつ。

従来のレイヤードアーキテクチャの依存関係を整理し、変更に強い設計にすることを目的としている。

他のアーキテクチャパターンとして、ヘキサゴナルアーキテクチャ、クリーンアーキテクチャがある。

#### 特徴

円の内側が上位のモジュールとして、内側への依存のみでモジュールを設計する。

共通となる概念(ドメイン)を中心に持つことで、各モジュールの修正を容易にできる。

例えばインフラ層を下位に持つことで、ビジネスロジックやDBの変更時に双方に影響なく修正することができる。

#### ドメインモデル
アプリケーションやサービス、ビジネスで必要な共通の概念を、抽象化してコードで表したもの。

ドメインモデルはドメイン特有の値や振る舞いを持つオブジェクトのイメージ。

他のモジュールには依存しておらず、独立している。

#### ドメインサービス
ドメインモデルで定義するには「不自然な」ふるまいを定義する層。

- 単一／複数集約の複数インスタンス間にまたがって実現するケース
- その処理過程・順序そのものがビジネスルールであるケース
- インタフェースを通じてインフラ層のふるまいと組み合わせるケース

例: 

- 口座間の資金振替 -> 資金振替 のために 引き落とし と 預け入れ を行う
- ユーザー認証における仕組みの隠蔽 -> テナントの有効状態確認、認証、パスワード暗号化 の知識をクライアント側から追い出す
- メールアドレス重複チェック -> ユーザーオブジェクト自身 は 他のユーザー の情報を持っていない
- 拠点間の輸送 -> 輸送 は必ず 出庫 と 入庫 のセットで行われる

参考: [ドメインサービスを書く時の判断基準と大事にしていること](https://tech.holmescloud.com/entry/2021/03/30/201900)

#### アプリケーションサービス
ドメインを用いて、機能を提供するロジックを実装する層。

#### インフラ,  ユーザインターフェース, テスト

データの永続層やサービスのUI、テストはドメインモデルとアプリケーションサービスと独立して実装する。
モジュールの境界にアダプターと呼ばれるインターフェースを用意することで、外側から内側への依存関係を固定する。


### どの層にも依存しないドメインモデル層のメリット

### 層を跨ぐ依存が発生する際、インターフェースに対する依存のみを許可するメリット

### 「依存性の逆転」がオニオンアーキテクチャの扱われ方

### 特定のユーザにしかリソースの追加や更新を許さないようなアクセス制限機能を実装する場合

### データベースをMySQLからPostgreSQLに変更する場合


#### 参考

- [世界一わかりやすいClean Architecture](https://www.slideshare.net/AtsushiNakamura4/clean-architecture-release)

## 課題２（クイズ）

1. hoge
2. hoge
3. hoge

  <summary>回答例</summary>

1. 
2. 
3. 

</details>
