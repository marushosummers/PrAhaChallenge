# 課題32: オニオンアーキテクチャを学ぶ

## 課題１(オニオンアーキテクチャの説明)

![オニオンアーキテクチャ](https://cdn-ak.f.st-hatena.com/images/fotolife/l/little_hands/20171011/20171011062558.png)

参考: [[DDD]ドメイン駆動 + オニオンアーキテクチャ概略](https://little-hands.hatenablog.com/entry/2017/10/11/075634)

オニオンアーキテクチャはDDD(ドメイン駆動開発)での設計パターンのひとつ。

従来のレイヤードアーキテクチャの依存関係を整理し、変更に強い設計にすることを目的としている。

### 特徴

円の内側が上位のモジュールとして、内側への依存のみでモジュールを設計する。

共通となる概念(ドメイン)を中心に持つことで、各モジュールの修正を容易にできる。

例えばインフラ層を下位に持つことで、ビジネスロジックやDBの変更時に双方に影響なく修正することができる。

### ドメインモデル
アプリケーションやサービス、ビジネスで必要な共通の概念を、抽象化してコードで表したもの。

ドメインモデルはドメイン特有の値や振る舞いを持つオブジェクトのイメージ。

他のモジュールには依存しておらず、独立している。

### ドメインサービス
ドメインモデルで定義するには「不自然な」ふるまいを定義する層。

- 単一／複数集約の複数インスタンス間にまたがって実現するケース
- その処理過程・順序そのものがビジネスルールであるケース
- インタフェースを通じてインフラ層のふるまいと組み合わせるケース

例: 

- 口座間の資金振替 -> 資金振替 のために 引き落とし と 預け入れ を行う
- ユーザー認証における仕組みの隠蔽 -> テナントの有効状態確認、認証、パスワード暗号化 の知識をクライアント側から追い出す
- メールアドレス重複チェック -> ユーザーオブジェクト自身 は 他のユーザー の情報を持っていない
- 拠点間の輸送 -> 輸送 は必ず 出庫 と 入庫 のセットで行われる

参考: [ドメインサービスを書く時の判断基準と大事にしていること](https://tech.holmescloud.com/entry/2021/03/30/201900)

### アプリケーションサービス
ドメインを用いて、機能を提供するロジックを実装する層。

### インフラ,  ユーザインターフェース, テスト

データの永続層やサービスのUI、テストはドメインモデルとアプリケーションサービスと独立して実装する。
モジュールの境界にアダプターと呼ばれるインターフェースを用意することで、外側から内側への依存関係を固定する。


### どの層にも依存しないドメインモデル層のメリット

ドメイン以外の変更の影響を受けなくなるため、
DomainModel、Applicationが常に独立した形で書くことができ、その単位で品質保証をすることができるメリットがある。

### 層を跨ぐ依存が発生する際、インターフェースに対する依存のみを許可するメリット

他の層からの影響をインターフェースのみを修正することで吸収することができる。
影響範囲が明確になり、コードの変更が容易になる。

### 「依存性の逆転」のオニオンアーキテクチャでの扱われ方

一般的にDBなどのインフラを上位レイヤとして、モデルがインフラに依存するように設計することがある。
オニオンアーキテクチャは、モデルを上位レイヤとしてインフラを依存させることで依存性の逆転を使っている。

### 特定のユーザにしかリソースの追加や更新を許さないようなアクセス制限機能を実装する場合

アプリケーションサービス層やドメインサービス層にアクセス制限機能を実装することで、インフラ層に変更があった場合にも独立して修正が可能になる。
### データベースをMySQLからPostgreSQLに変更する場合
上位レイヤに定義されたRepositoryの抽象クラスに、インフラ層でMysql/PostogresへアクセスするクラスをDIすることで柔軟に変更を行える。

### 参考

- [世界一わかりやすいClean Architecture](https://www.slideshare.net/AtsushiNakamura4/clean-architecture-release)

## 課題２（クイズ）

1. オニオンアーキテクチャ以外でDDDで使われるアーキテクチャを挙げてください
2. オニオンアーキテクチャでは、外部の層とやりとりするためのインターフェースを何と呼ぶか
3. レイヤードアーキテクチャと比べ、オニオンアーキテクチャだった場合にその恩恵を受けられる仕様変更例を1つ挙げてください

<summary>回答例</summary>

1. クリーンアーキテクチャ、ヘキサゴナルアーキテクチャ、レイヤードアーキテクチャ
2. アダプター
3. ユーザーへの通知メールを独自サーバーからSendGridなどのクラウドサービスに載せ替える

</details>
