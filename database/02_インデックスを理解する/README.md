# 課題16: インデックスを理解する

## 課題１（質問）

### インデックスの仕組み

```
インデックスはデータベースのデータを早く検索するための仕組みです。

インデックスは「索引」という意味で、本の巻末についている「あ〜を」の索引をイメージすると分かりやすいです。

例えば、本の中から「プラハ」という文字列を探すのは大変だけれど、索引を見れば何ページにあるかすぐわかるよね。

インデックスを付与すると（よくインデックスを張るというけれど）は、インデックスの無いデータに比べてSELECTしたときの応答速度が高速になるので、

アプリケーションへデータを返すのが早くなって、レスポンスが改善されることがあるんだ。

一方で、インデックスの貼られたデータを更新したり追加するときは注意が必要です。

本の例でいうと、更新がかかるたびに索引ページも整理・更新する時間がかかるのと同じです。

必要のないデータにインデックスを貼ってしまうと、更新の度にこの処理が必要になって、逆にパフォーマンスが悪化することもあります。

インデックス内部のデータ構造については、B木、B+木といった構造で保持されているから、興味があったら調べてみるといいよ。
```

## なぜslow query logを調べる必要があるか？
slow query logはSQLの実行時間をログとして出力する機能。

SQLの実行時間を調べることで、以下のことを適宜確認して適切なクエリを書くことができる。
- 適切な実行時間のクエリになっているか
- インデックスの追加でパフォーマンスが改善するか
- 不要なインデックスによってパフォーマンスが悪化していないか


## カーディナリティとは
カーディナリティは、カラムに格納されているデータの種類がどのくらいあるかを示す指標。

例えば性別なら、男と女の二種類でカーディナリティが低い。一方で、ユーザーIDはデータごとに異なるのでカーディナリティが高い。

カーディナリティが高いデータほど、インデックスの恩恵を受けられる。

## カバリングインデックスとは

取得するデータ全てにインデックスが貼られている場合、データを直接取得する必要が無いためクエリが高速になる。

これを実現するために、クエリで取得するデータを網羅的にインデックスにすることカバリングインデックスという。


# 課題２（実装）

従業員データの入ったMysqlを立ち上げる
- https://hub.docker.com/r/genschsa/mysql-employees

- 起動方法
```
> docker run -d \
  --platform linux/x86_64 \
  --name mysql-employees \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=college \
  -v $PWD/data:/var/lib/mysql \
  genschsa/mysql-employees

> docker exec -it mysql-employees /bin/bash

> mysql -pcollege
```

## WHERE句を1つだけ含むSELECTクエリ

1. employeesから`first_name = Taizo`のデータの数を調べる
```sql
SELECT COUNT(*) FROM employees WHERE first_name = "Taizo";
```

2. employeesから男性のデータの数を調べる
```sql
SELECT COUNT(emp_no) FROM employees WHERE gender = "M";
```

3. salariesからsalary=10,000のデータの数を調べる
```sql
SELECT COUNT(*) FROM salaries WHERE salary = 100000;
```

### performance_schemaで実行速度を測定

- 実行速度の確認クエリ
```SQL
SELECT sql_text, sys.format_time(timer_wait) AS time FROM performance_schema.events_statements_history WHERE sql_text IS NOT NULL;
```

1. employeesから`first_name = Taizo`のデータを検索する
```
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                          | time      |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| SELECT COUNT(*) FROM employees WHERE first_name = "Taizo"                                                                         | 82.46 ms  |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
```

2. employeesから男性のデータの数を調べる

```
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                          | time      |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| SELECT COUNT(emp_no) FROM employees WHERE gender = "M"                                                                            | 67.50 ms  |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
```

3. salariesからsalaryが10,000超えのデータの数を調べる

```
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                          | time      |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| SELECT COUNT(*) FROM salaries WHERE salary = 100000                                                                               | 699.23 ms |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
```

## インデックスを追加

```sql
CREATE INDEX first_name_index ON employees(first_name);
CREATE INDEX gender_index ON employees(gender);
CREATE INDEX salary_index ON salaries(salary);
```

### 実行速度を測定

1. employeesから`first_name = Taizo`のデータを検索する: 82.46ms -> 436.72us
```
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                          | time      |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| SELECT COUNT(*) FROM employees WHERE first_name = "Taizo"                                                                         | 436.72 us |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
```

2. employeesから男性のデータの数を調べる: 67.5ms -> 52.19ms

```
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                          | time      |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| SELECT COUNT(emp_no) FROM employees WHERE gender = "M"                                                                            | 52.19 ms  |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
```

3. salariesからsalaryが10,000超えのデータの数を調べる: 699.23ms -> 286.87us

```
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                          | time      |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
| SELECT COUNT(*) FROM salaries WHERE salary = 100000                                                                               | 286.87 us |
+-----------------------------------------------------------------------------------------------------------------------------------+-----------+
```

## インデックスが使われているか確認

1. employeesから`first_name = Taizo`のデータを検索する
```sql
mysql> EXPLAIN SELECT count(*) FROM employees WHERE first_name = "Taizo";
+----+-------------+-----------+------------+------+------------------+------------------+---------+-------+------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys    | key              | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-----------+------------+------+------------------+------------------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | employees | NULL       | ref  | first_name_index | first_name_index | 16      | const |  248 |   100.00 | Using index |
+----+-------------+-----------+------------+------+------------------+------------------+---------+-------+------+----------+-------------+
```

2. employeesから男性のデータの数を調べる
```sql
mysql> EXPLAIN SELECT COUNT(emp_no) FROM employees WHERE gender = "M";
+----+-------------+-----------+------------+------+---------------+--------------+---------+-------+--------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys | key          | key_len | ref   | rows   | filtered | Extra       |
+----+-------------+-----------+------------+------+---------------+--------------+---------+-------+--------+----------+-------------+
|  1 | SIMPLE      | employees | NULL       | ref  | gender_index  | gender_index | 1       | const | 149601 |   100.00 | Using index |
+----+-------------+-----------+------------+------+---------------+--------------+---------+-------+--------+----------+-------------+
```

3. salariesからsalary=10,000のデータの数を調べる
```sql
mysql> EXPLAIN SELECT COUNT(*) FROM salaries WHERE salary = 100000;
+----+-------------+----------+------------+------+---------------+--------------+---------+-------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys | key          | key_len | ref   | rows | filtered | Extra       |
+----+-------------+----------+------------+------+---------------+--------------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | salaries | NULL       | ref  | salary_index  | salary_index | 4       | const |   13 |   100.00 | Using index |
+----+-------------+----------+------------+------+---------------+--------------+---------+-------+------+----------+-------------+
```


# 課題３（実装）

- インデックスなし
```sql
INSERT INTO employees VALUES('500000', '1992-01-01', 'Taro', 'Sato', 'M', '2020-01-01');

+-----------------------------------------------------------------------------------------+---------+
| sql_text                                                                                | time    |
+-----------------------------------------------------------------------------------------+---------+
| INSERT INTO employees VALUES('500000', '1992-01-01', 'Taro', 'Sato', 'M', '2020-01-01') | 1.65 ms |
+-----------------------------------------------------------------------------------------+---------+

DELETE FROM employees WHERE emp_no = 500000;

+---------------------------------------------+---------+
| sql_text                                    | time    |
+---------------------------------------------+---------+
| DELETE FROM employees WHERE emp_no = 500000 | 1.78 ms |
+---------------------------------------------+---------+
```

- インデックスあり

```sql
INSERT INTO employees VALUES('500000', '1992-01-01', 'Taro', 'Sato', 'M', '2020-01-01');

+---------------------------------------------------------------------------------------------------------------------------------------+-----------+
| sql_text                                                                                                                              | time      |
+---------------------------------------------------------------------------------------------------------------------------------------+-----------+
| INSERT INTO employees VALUES('500000', '1992-01-01', 'Taro', 'Sato', 'M', '2020-01-01')                                               | 1.98 ms   |
+---------------------------------------------------------------------------------------------------------------------------------------+-----------+

DELETE FROM employees WHERE emp_no = 500000;

+---------------------------------------------+---------+
| sql_text                                    | time    |
+---------------------------------------------+---------+
| DELETE FROM employees WHERE emp_no = 500000 | 1.84 ms |
+---------------------------------------------+---------+
```

インデックスのあるテーブルに追加・更新・削除を行うと、インデックスの再計算が行われるため、
インデックスが無い場合と比較して実行時間が長くなる傾向がある


# 課題4（クイズ）

1. 何月入社が多いか調べるために、入社月ごとの従業員数を集計してください
2. どの肩書きの社員が多いか調べるために、現在の肩書きごとの従業員数を集計してください
3. 現在の全社員の給与平均を調べてください

<details>
  <summary>回答例</summary>

1. 
```sql
SELECT
  DATE_FORMAT(hire_date, '%m') AS month,
  COUNT(emp_no) AS hire_month_counts
FROM employees 
GROUP BY month
ORDER BY hire_month_counts DESC;
```

2. 
```sql
SELECT
  title,
  count(title) AS title_count
FROM employees
JOIN titles USING(emp_no)
WHERE to_date = '9999-01-01'
GROUP BY title
ORDER BY title_count DESC;
```

3. 
```sql
SELECT
  AVG(salary) AS salary_average
FROM employees
JOIN salaries USING(emp_no)
WHERE to_date = '9999-01-01';
```

</details>
